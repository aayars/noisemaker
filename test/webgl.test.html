<!DOCTYPE html>
<html>
<body>
<script type="module">
import { Context } from '../src/context.js';
import { values, downsample, upsample, blend, sobel } from '../src/value.js';
import { Tensor } from '../src/tensor.js';
import {
  adjustBrightness,
  adjustContrast,
  vignette,
  reindex,
  dither,
  grain,
} from '../src/effects.js';
import { render } from '../src/composer.js';
import { ValueDistribution } from '../src/constants.js';
const canvas = document.createElement('canvas');
const ctx = new Context(canvas);
const cpuCtx = new Context(null);

function nearly(a, b, eps = 1e-3) { return Math.abs(a - b) < eps; }

function testEffect(fn, args = [], time = 0, speed = 0) {
  const shape = [2,2,3];
  const base = values(1, shape, { seed: 1, ctx: cpuCtx }).read();
  const cpuBase = Tensor.fromArray(cpuCtx, base, shape);
  const gpuBase = Tensor.fromArray(ctx, base, shape);
  const cpu = fn(cpuBase, shape, time, speed, ...args).read();
  const gpu = fn(gpuBase, shape, time, speed, ...args).read();
  if (cpu.length !== gpu.length) return false;
  for (let i = 0; i < cpu.length; i++) {
    if (!nearly(cpu[i], gpu[i])) return false;
  }
  return true;
}

const base = values(2, [4,4,1], { seed: 1, ctx });
const down = downsample(base, 2);
const up = upsample(down, 2);
const mix = blend(base, base, 0.5);
const edge = sobel(base);

  const baseCpu = values(2, [4,4,1], { seed: 1, ctx: cpuCtx }).read();
  const baseGpu = base.read();
  let baseEqual = baseCpu.length === baseGpu.length;
  if (baseEqual) {
    for (let i = 0; i < baseCpu.length; i++) {
      if (!nearly(baseCpu[i], baseGpu[i])) { baseEqual = false; break; }
    }
  }

  const vertPresets = { vert: { generator: () => ({ distrib: ValueDistribution.scan_up }) } };
  render('vert', 0, { ctx, width: 2, height: 2, presets: vertPresets });
  const vImg = canvas.getContext('2d', { willReadFrequently: true }).getImageData(0, 0, 2, 2).data;
  const vTop = vImg[0];
  const vBottom = vImg[8];

  const horizPresets = { horiz: { generator: () => ({ distrib: ValueDistribution.scan_left }) } };
  render('horiz', 0, { ctx, width: 2, height: 2, presets: horizPresets });
  const hImg = canvas.getContext('2d', { willReadFrequently: true }).getImageData(0, 0, 2, 2).data;
  const hLeft = hImg[0];
  const hRight = hImg[4];

  const orientOk = vTop > vBottom && hLeft < hRight;

  const ok =
    baseEqual &&
    baseGpu.length === 16 &&
    down.read().length === 4 &&
  up.read().length === 16 &&
  mix.read().length === 16 &&
  edge.read().length === 16 &&
  testEffect(adjustBrightness, [0.1]) &&
  testEffect(adjustContrast, [1.2]) &&
  testEffect(grain, [0.25]) &&
  testEffect(dither, [2]) &&
    testEffect(vignette, [0.2, 0.5]) &&
    testEffect(reindex, [0.5]) &&
    orientOk;

document.body.textContent = ok ? 'webgl ok' : 'webgl fail';
</script>
</body>
</html>
