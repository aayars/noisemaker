#version 300 es
precision highp float;
precision highp int;

uniform sampler2D inputTex;
uniform float levels;
uniform float gamma;
uniform float time;

out vec4 fragColor;

const float MIN_LEVELS = 1.0;
const float MIN_GAMMA = 1e-3;

float clamp_01(float value) {
    return clamp(value, 0.0, 1.0);
}

float srgb_to_linear_component(float value) {
    if (value <= 0.04045) {
        return value / 12.92;
    }
    return pow((value + 0.055) / 1.055, 2.4);
}

float linear_to_srgb_component(float value) {
    if (value <= 0.0031308) {
        return value * 12.92;
    }
    return 1.055 * pow(value, 1.0 / 2.4) - 0.055;
}

vec3 srgb_to_linear_rgb(vec3 rgb) {
    return vec3(
        srgb_to_linear_component(rgb.x),
        srgb_to_linear_component(rgb.y),
        srgb_to_linear_component(rgb.z)
    );
}

vec3 linear_to_srgb_rgb(vec3 rgb) {
    return vec3(
        linear_to_srgb_component(rgb.x),
        linear_to_srgb_component(rgb.y),
        linear_to_srgb_component(rgb.z)
    );
}

vec3 pow_vec3(vec3 value, float exponent) {
    return vec3(
        pow(value.x, exponent),
        pow(value.y, exponent),
        pow(value.z, exponent)
    );
}

void main() {
    vec2 uv = gl_FragCoord.xy / vec2(textureSize(inputTex, 0));
    vec4 texel = texture(inputTex, uv);

    float levels_raw = max(levels, 0.0);
    float levels_quantized = max(round(levels_raw), MIN_LEVELS);
    if (levels_quantized <= 1.0) {
        fragColor = texel;
        return;
    }

    float level_factor = levels_quantized;
    float inv_factor = 1.0 / level_factor;
    float half_step = inv_factor * 0.5;
    float gamma_value = max(gamma, MIN_GAMMA);
    float inv_gamma = 1.0 / gamma_value;

    // Assume RGB input
    bool convert_to_linear = true;

    vec3 working_rgb = texel.xyz;
    if (convert_to_linear) {
        working_rgb = srgb_to_linear_rgb(working_rgb);
    }
    working_rgb = pow_vec3(clamp(working_rgb, vec3(0.0), vec3(1.0)), gamma_value);

    // Posterize
    working_rgb = working_rgb * level_factor;
    working_rgb = working_rgb + vec3(half_step);
    working_rgb = floor(working_rgb);
    vec3 quantized_rgb = working_rgb * inv_factor;
    quantized_rgb = pow_vec3(clamp(quantized_rgb, vec3(0.0), vec3(1.0)), inv_gamma);

    if (convert_to_linear) {
        quantized_rgb = linear_to_srgb_rgb(quantized_rgb);
    }

    vec4 result_color = vec4(
        clamp_01(quantized_rgb.x),
        clamp_01(quantized_rgb.y),
        clamp_01(quantized_rgb.z),
        texel.w
    );

    fragColor = result_color;
}
